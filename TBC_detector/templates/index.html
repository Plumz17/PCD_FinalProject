<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBC Detection System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

    <script>
        function cleanupSession(sessionId) {
            // Show loading state
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Resetting...';
            
            fetch(`/cleanup/${sessionId}`, { method: "POST" })
                .then(r => r.json())
                .then(data => {
                    console.log("cleanup:", data);
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 500);
                })
                .catch(err => {
                    console.error("Cleanup failed:", err);
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                });
        }
    </script>
</head>
<body>
<div class="main-container">
    <h1>ü©∫ TB X-ray Analysis with DIP</h1>

    {% if not model_loaded %}
        <div class="not-loaded">‚ö† Model belum dimuat. Pastikan <code>model/model.pkl</code> tersedia.</div>
    {% endif %}

    {% if error %}
        <div class="error-box">{{ error }}</div>
    {% endif %}

    <div class="card">
        <form action="/predict" method="post" enctype="multipart/form-data" id="uploadForm">
            <div class="form-group">
                <label for="file-input">üì§ Upload X-Ray Image</label>
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </div>
                    <p class="upload-text"><strong>Click to upload</strong> or drag and drop</p>
                    <p class="upload-hint">PNG, JPG, JPEG (Max 8MB)</p>
                    <input type="file" name="image" id="file-input" accept=".png,.jpg,.jpeg" hidden>
                    <img id="preview-img" src="" alt="Preview">
                </div>
            </div>

            <button type="submit" class="btn-analyze" {% if not model_loaded %}disabled{% endif %}>
                üîç Analyze Image
            </button>
        </form>
    </div>

    {% if prediction is defined %}
    
    <div class="diagnosis-card">
        <div class="diagnosis-info">
            <div class="diagnosis-label">DIP Diagnosis Result</div>
            
            {% if prediction == 0 %}
                <h2 class="diagnosis-result status-normal">‚úì Normal</h2>
                <div class="diagnosis-desc">
                    Tidak ditemukan kelainan signifikan terkait Tuberkulosis. Hasil X-Ray menunjukkan gambaran normal tanpa indikasi TB.
                    <br><br>
                    <small><i>‚ö† Disclaimer: Hasil ini adalah diagnosis awal menggunakan DIP. Selalu konsultasikan dengan dokter spesialis untuk hasil yang pasti dan komprehensif.</i></small>
                </div>
            {% elif prediction == 1 %}
                <h2 class="diagnosis-result status-danger">‚ö†Ô∏è TB Detected</h2>
                <div class="diagnosis-desc">
                    Terdeteksi indikasi yang mengarah pada Tuberkulosis. Hasil X-Ray menunjukkan gambaran dengan indikasi TB.
                    <br><br>
                    <small><i>‚ö† Disclaimer: Hasil ini adalah diagnosis awal menggunakan DIP. Selalu konsultasikan dengan dokter spesialis untuk hasil yang pasti dan komprehensif.</i></small>
                </div>
            {% else %}
                <h2 class="diagnosis-result status-unknown">‚ùì Unknown</h2>
                <div class="diagnosis-desc">
                    Hasil diagnosis tidak dapat ditentukan.
                    <br><br>
                    <small><i>‚ö† Disclaimer: Hasil ini adalah diagnosis awal menggunakan DIP.</i></small>
                </div>
            {% endif %}

            {% if session_id %}
            <div style="margin-top: 30px;">
                <button type="button" onclick="cleanupSession('{{ session_id }}')" class="btn-cleanup">
                    Reset Analysis
                </button>
            </div>
            {% endif %}
        </div>

        <div class="diagnosis-visuals">
            <div class="visual-header">üìä Image Processing Steps</div>
            
            <div class="steps-grid-container">
                {% if upload_image %}
                <div class="step-card">
                    <img src="{{ upload_image }}" alt="Original">
                    <span>Original Image</span>
                </div>
                {% endif %}

                {% if steps %}
                    {% for name, path in steps.items() %}
                    <div class="step-card">
                        <img src="{{ path }}" alt="{{ name }}">
                        <span>{{ name }}</span>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>

    {% endif %}
</div>

<script>
    const fileInput = document.getElementById('file-input');
    const uploadArea = document.getElementById('upload-area');
    const previewImg = document.getElementById('preview-img');
    const uploadIcon = document.querySelector('.upload-icon');
    const uploadText = document.querySelector('.upload-text');
    const uploadHint = document.querySelector('.upload-hint');
    const form = document.getElementById('uploadForm');

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.add('drag-active');
    });

    uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove('drag-active');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove('drag-active');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect(files[0]);
        }
    });

    function handleFileSelect(file) {
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(event) {
                previewImg.src = event.target.result;
                previewImg.style.display = 'block';
                uploadIcon.style.display = 'none';
                uploadText.style.display = 'none';
                uploadHint.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    }

    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) handleFileSelect(this.files[0]);
    });

    form.addEventListener('submit', function() {
        const btn = document.querySelector('.btn-analyze');
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Processing...';
        btn.style.opacity = '0.7';
    });
    
    previewImg.src = '';
</script>
</body>
</html>